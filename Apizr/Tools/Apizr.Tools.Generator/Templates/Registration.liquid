using Apizr;
using Apizr.Configuring.Registry;
using Microsoft.Extensions.DependencyInjection;
{% if WithRetry -%}
using System;
using Apizr.Policing;
using Polly;
using Polly.Extensions.Http;
using Polly.Registry;
{% endif -%}

{% if WithRetry -%}
[assembly:Policy("TransientHttpError")]
{% endif -%}
namespace {{ NameSpace }}
{
    public static class ApizrRegistration
    {
{%      if WithRetry -%}
        public static PolicyRegistry ApizrPolicyRegistry = new PolicyRegistry
        {
            {
                "TransientHttpError", HttpPolicyExtensions.HandleTransientHttpError().WaitAndRetryAsync(new[]
                {
                    TimeSpan.FromSeconds(1),
                    TimeSpan.FromSeconds(5),
                    TimeSpan.FromSeconds(10)
                }, LoggedPolicies.OnLoggedRetry).WithPolicyKey("TransientHttpError")
            }
        };

{%      endif -%}
{%      if RegistrationType == 'Static' or RegistrationType == 'Both' -%}
        public static IApizrRegistry Build() =>
            ApizrBuilder.CreateRegistry(
                registry => registry
{%                  for service in Services -%}
                    .AddManagerFor<I{{ service }}Service>(){% if service == LastService %},{% endif %}
{%                  endfor -%}
                options => options.WithBaseAddress("{{BaseUrl}}")
{%                  if WithRetry -%}
                    .WithPolicyRegistry(ApizrPolicyRegistry)
{%                  endif -%}
            );
{%      endif -%}
{%      if RegistrationType == 'Extended' or RegistrationType == 'Both' -%}
{%      if RegistrationType == 'Both' -%}

{%      endif -%}
        public static IServiceCollection AddApizr(this IServiceCollection services)
        {
{%          if WithRetry -%}
            services.AddPolicyRegistry(ApizrPolicyRegistry);

{%          endif -%}
            services.AddApizr(
                registry => registry
{%                  for service in Services -%}
                    .AddManagerFor<I{{ service }}Service>(){% if service == LastService %},{% endif %}
{%                  endfor -%}
                options => options.WithBaseAddress("{{BaseUrl}}")
            );

            return services;
        }
{%      endif -%}
    }
}